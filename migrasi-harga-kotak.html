<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Migrasi Harga Kotak - Copy dari kodeAksesoris ke stokAksesoris</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem;
      }
      .card {
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }
      .log-container {
        max-height: 400px;
        overflow-y: auto;
        background: #1e1e1e;
        color: #0f0;
        font-family: monospace;
        font-size: 13px;
        padding: 15px;
        border-radius: 8px;
      }
      .log-entry {
        margin-bottom: 5px;
        padding: 3px 0;
        border-bottom: 1px solid #333;
      }
      .log-success {
        color: #4ade80;
      }
      .log-error {
        color: #f87171;
      }
      .log-info {
        color: #60a5fa;
      }
      .log-warning {
        color: #fbbf24;
      }
      .stats-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }
      .stats-number {
        font-size: 2rem;
        font-weight: bold;
        color: #4f46e5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h3 class="mb-0">
                <i class="fas fa-database me-2"></i>
                Migrasi Harga Kotak
              </h3>
              <small>Copy field harga dari kodeAksesoris ke stokAksesoris</small>
            </div>
            <div class="card-body">
              <!-- Login Form -->
              <div id="loginSection" class="mb-4">
                <div class="alert alert-warning">
                  <i class="fas fa-lock me-2"></i>
                  <strong>Login Required</strong>
                  - Masukkan kredensial admin untuk mengakses database
                </div>
                <div class="row g-3">
                  <div class="col-md-5">
                    <input type="email" class="form-control" id="email" placeholder="Email" value="" />
                  </div>
                  <div class="col-md-5">
                    <input type="password" class="form-control" id="password" placeholder="Password" />
                  </div>
                  <div class="col-md-2">
                    <button class="btn btn-primary w-100" id="btnLogin">
                      <i class="fas fa-sign-in-alt me-1"></i>
                      Login
                    </button>
                  </div>
                </div>
                <div id="loginError" class="text-danger mt-2" style="display: none"></div>
              </div>

              <!-- Main Content (hidden until logged in) -->
              <div id="mainContent" style="display: none">
                <!-- Stats -->
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="stats-card">
                      <div class="stats-number" id="totalKotak">-</div>
                      <div class="text-muted">Total Kotak</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="stats-card">
                      <div class="stats-number text-success" id="successCount">0</div>
                      <div class="text-muted">Berhasil</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="stats-card">
                      <div class="stats-number text-danger" id="errorCount">0</div>
                      <div class="text-muted">Gagal</div>
                    </div>
                  </div>
                </div>

                <!-- Progress -->
                <div class="mb-4">
                  <div class="d-flex justify-content-between mb-1">
                    <span>Progress</span>
                    <span id="progressText">0%</span>
                  </div>
                  <div class="progress" style="height: 25px">
                    <div
                      class="progress-bar progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      id="progressBar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>

                <!-- Buttons -->
                <div class="d-grid gap-2 mb-4">
                  <button class="btn btn-info btn-lg" id="btnPreview">
                    <i class="fas fa-eye me-2"></i>
                    Preview Data (Lihat Dulu)
                  </button>
                  <button class="btn btn-success btn-lg" id="btnMigrate" disabled>
                    <i class="fas fa-play me-2"></i>
                    Jalankan Migrasi
                  </button>
                </div>

                <!-- Log -->
                <h5>
                  <i class="fas fa-terminal me-2"></i>
                  Log
                </h5>
                <div class="log-container" id="logContainer">
                  <div class="log-entry log-info">Klik "Preview Data" untuk memulai...</div>
                </div>
              </div>
              <!-- End mainContent -->
            </div>
            <div class="card-footer text-muted">
              <i class="fas fa-info-circle me-2"></i>
              Script ini akan menyalin field
              <code>harga</code>
              dari
              <code>kodeAksesoris/kategori/kotak</code>
              ke
              <code>stokAksesoris</code>
              untuk semua item kotak.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        updateDoc,
        doc,
        limit,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

      // Firebase config - CORRECT CONFIG from configFirebase.js
      const firebaseConfig = {
        apiKey: "AIzaSyA7JvWu5eDgSYjUyfAH1DuN3b3CTwVz-ps",
        authDomain: "aksesoris-app-7be90.firebaseapp.com",
        projectId: "aksesoris-app-7be90",
        storageBucket: "aksesoris-app-7be90.firebasestorage.app",
        messagingSenderId: "458967126225",
        appId: "1:458967126225:web:10fe8c5724303b7d2cf5f0",
      };

      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const auth = getAuth(app);

      // State
      let kotakData = [];
      let successCount = 0;
      let errorCount = 0;

      // DOM Elements
      const logContainer = document.getElementById("logContainer");
      const btnPreview = document.getElementById("btnPreview");
      const btnMigrate = document.getElementById("btnMigrate");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      // Log function
      function log(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      // Update stats
      function updateStats() {
        document.getElementById("totalKotak").textContent = kotakData.length;
        document.getElementById("successCount").textContent = successCount;
        document.getElementById("errorCount").textContent = errorCount;
      }

      // Update progress
      function updateProgress(current, total) {
        const percent = Math.round((current / total) * 100);
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `${percent}%`;
      }

      // Preview data
      async function previewData() {
        try {
          btnPreview.disabled = true;
          btnPreview.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';

          logContainer.innerHTML = "";
          log("üîç Memuat data dari kodeAksesoris/kategori/kotak...", "info");

          // Get all kotak from kodeAksesoris
          const kotakSnapshot = await getDocs(collection(firestore, "kodeAksesoris", "kategori", "kotak"));

          kotakData = [];
          kotakSnapshot.forEach((doc) => {
            const data = doc.data();
            kotakData.push({
              id: doc.id,
              kode: data.text,
              nama: data.nama,
              harga: data.harga || 0,
            });
          });

          log(`üì¶ Ditemukan ${kotakData.length} item kotak`, "success");

          // Preview each item
          for (const item of kotakData) {
            // Check if exists in stokAksesoris
            const stockQuery = query(collection(firestore, "stokAksesoris"), where("kode", "==", item.kode), limit(1));
            const stockSnapshot = await getDocs(stockQuery);

            if (stockSnapshot.empty) {
              log(
                `‚ö†Ô∏è ${item.kode} - "${item.nama}" - Rp ${item.harga.toLocaleString()} - <span class="text-warning">TIDAK ADA di stokAksesoris</span>`,
                "warning",
              );
            } else {
              const stockData = stockSnapshot.docs[0].data();
              const currentHarga = stockData.harga || "BELUM ADA";
              log(
                `‚úì ${item.kode} - "${item.nama}" - Harga: Rp ${item.harga.toLocaleString()} (saat ini: ${typeof currentHarga === "number" ? "Rp " + currentHarga.toLocaleString() : currentHarga})`,
                "info",
              );
            }
          }

          updateStats();
          btnMigrate.disabled = false;
          log("", "info");
          log('‚úÖ Preview selesai. Klik "Jalankan Migrasi" untuk memulai.', "success");
        } catch (error) {
          log(`‚ùå Error: ${error.message}`, "error");
          console.error(error);
        } finally {
          btnPreview.disabled = false;
          btnPreview.innerHTML = '<i class="fas fa-eye me-2"></i>Preview Data (Lihat Dulu)';
        }
      }

      // Run migration
      async function runMigration() {
        if (!confirm("Apakah Anda yakin ingin menjalankan migrasi? Pastikan sudah backup data!")) {
          return;
        }

        try {
          btnMigrate.disabled = true;
          btnMigrate.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Migrating...';
          btnPreview.disabled = true;

          successCount = 0;
          errorCount = 0;

          log("", "info");
          log("üöÄ Memulai migrasi...", "info");

          for (let i = 0; i < kotakData.length; i++) {
            const item = kotakData[i];

            try {
              // Find in stokAksesoris
              const stockQuery = query(
                collection(firestore, "stokAksesoris"),
                where("kode", "==", item.kode),
                limit(1),
              );
              const stockSnapshot = await getDocs(stockQuery);

              if (stockSnapshot.empty) {
                log(`‚ö†Ô∏è SKIP: ${item.kode} - Tidak ditemukan di stokAksesoris`, "warning");
                errorCount++;
              } else {
                // Update harga
                const stockDocRef = doc(firestore, "stokAksesoris", stockSnapshot.docs[0].id);
                await updateDoc(stockDocRef, {
                  harga: item.harga,
                });

                log(`‚úÖ ${item.kode} - Harga diupdate ke Rp ${item.harga.toLocaleString()}`, "success");
                successCount++;
              }
            } catch (error) {
              log(`‚ùå ERROR ${item.kode}: ${error.message}`, "error");
              errorCount++;
            }

            updateProgress(i + 1, kotakData.length);
            updateStats();

            // Small delay to avoid rate limiting
            await new Promise((resolve) => setTimeout(resolve, 100));
          }

          log("", "info");
          log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
          log(`üéâ MIGRASI SELESAI!`, "success");
          log(`‚úÖ Berhasil: ${successCount}`, "success");
          log(`‚ùå Gagal: ${errorCount}`, errorCount > 0 ? "error" : "info");
          log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", "info");
        } catch (error) {
          log(`‚ùå Fatal Error: ${error.message}`, "error");
          console.error(error);
        } finally {
          btnMigrate.disabled = false;
          btnMigrate.innerHTML = '<i class="fas fa-play me-2"></i>Jalankan Migrasi';
          btnPreview.disabled = false;
        }
      }

      // Event listeners
      btnPreview.addEventListener("click", previewData);
      btnMigrate.addEventListener("click", runMigration);

      // Login elements
      const loginSection = document.getElementById("loginSection");
      const mainContent = document.getElementById("mainContent");
      const btnLogin = document.getElementById("btnLogin");
      const loginError = document.getElementById("loginError");

      // Check auth state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          loginSection.style.display = "none";
          mainContent.style.display = "block";
          log(`‚úÖ Logged in as: ${user.email}`, "success");
          log('üîß Script siap. Klik "Preview Data" untuk melihat data yang akan dimigrasi.', "info");
        } else {
          loginSection.style.display = "block";
          mainContent.style.display = "none";
        }
      });

      // Login handler
      btnLogin.addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        if (!email || !password) {
          loginError.textContent = "Email dan password harus diisi!";
          loginError.style.display = "block";
          return;
        }

        try {
          btnLogin.disabled = true;
          btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          loginError.style.display = "none";

          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged will handle the UI update
        } catch (error) {
          console.error("Login error:", error);
          loginError.textContent = "Login gagal: " + error.message;
          loginError.style.display = "block";
        } finally {
          btnLogin.disabled = false;
          btnLogin.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i> Login';
        }
      });

      // Allow Enter key to submit login
      document.getElementById("password").addEventListener("keypress", (e) => {
        if (e.key === "Enter") btnLogin.click();
      });
    </script>
  </body>
</html>
